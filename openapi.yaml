openapi: 3.0.3
info:
  title: 動漫猜謎遊戲 API
  description: 用於管理動漫猜謎遊戲的 API，包含遊戲創建、問題管理、玩家互動等功能
  version: 1.0.0
servers:
  - url: https://api.example.com/v1
    description: 生產環境
  - url: https://staging-api.example.com/v1
    description: 測試環境

tags:
  - name: 遊戲管理
    description: 創建、獲取和管理遊戲相關操作
  - name: 玩家管理
    description: 添加玩家和獲取玩家排名相關操作
  - name: 問題管理
    description: 創建和管理問題相關操作

paths:
  /games:
    post:
      summary: 創建新遊戲
      description: 創建一個新的動漫猜謎遊戲
      tags:
        - 遊戲管理
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                gameTitle:
                  type: string
                  description: 遊戲標題
                  example: "Anime Guessing Game"
                settings:
                  $ref: '#/components/schemas/GameSettings'
                hostId:
                  type: string
                  description: 主持人ID
                  example: "host123456"
      responses:
        '201':
          description: 遊戲創建成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "遊戲創建成功"
                  game:
                    $ref: '#/components/schemas/Game'
        '500':
          description: 伺服器錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /games/{gameId}:
    get:
      summary: 獲取特定遊戲資訊
      description: 根據遊戲ID獲取遊戲詳細資訊，包含遊戲中的玩家排名
      tags:
        - 遊戲管理
      parameters:
        - name: gameId
          in: path
          required: true
          schema:
            type: string
          description: 遊戲唯一ID
          example: "a1b2c3d4"
      responses:
        '200':
          description: 成功獲取遊戲資訊
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  game:
                    allOf:
                      - $ref: '#/components/schemas/Game'
                      - type: object
                        properties:
                          players:
                            type: array
                            items:
                              $ref: '#/components/schemas/PlayerRanking'
                          questionCount:
                            type: integer
                            description: 遊戲中的問題數量
                            example: 10
        '404':
          description: 找不到遊戲
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: 伺服器錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /games/{gameId}/settings:
    patch:
      summary: 更新遊戲設定
      description: 更新指定遊戲的設定參數
      tags:
        - 遊戲管理
      parameters:
        - name: gameId
          in: path
          required: true
          schema:
            type: string
          description: 遊戲唯一ID
          example: "a1b2c3d4"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                settings:
                  $ref: '#/components/schemas/GameSettings'
      responses:
        '200':
          description: 遊戲設定更新成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "遊戲設定更新成功"
                  game:
                    $ref: '#/components/schemas/Game'
        '400':
          description: 請求錯誤，可能是遊戲已開始
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 找不到遊戲
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: 伺服器錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /games/{gameId}/players:
    post:
      summary: 添加玩家到遊戲
      description: 將新玩家添加到指定的遊戲中
      tags:
        - 玩家管理
      parameters:
        - name: gameId
          in: path
          required: true
          schema:
            type: string
          description: 遊戲唯一ID
          example: "a1b2c3d4"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                  description: 玩家名稱
                  example: "player1"
              required:
                - username
      responses:
        '201':
          description: 成功添加玩家
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "成功加入遊戲"
                  player:
                    $ref: '#/components/schemas/Player'
        '400':
          description: 請求錯誤，可能是缺少用戶名或遊戲已開始
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 找不到遊戲
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: 衝突，用戶名已存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: 伺服器錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    
    get:
      summary: 獲取遊戲玩家
      description: 獲取指定遊戲中的所有玩家，按分數排序
      tags:
        - 玩家管理
      parameters:
        - name: gameId
          in: path
          required: true
          schema:
            type: string
          description: 遊戲唯一ID
          example: "a1b2c3d4"
      responses:
        '200':
          description: 成功獲取玩家列表
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  players:
                    type: array
                    items:
                      $ref: '#/components/schemas/PlayerRanking'
        '404':
          description: 找不到遊戲
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: 伺服器錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /games/{gameId}/start:
    post:
      summary: 開始遊戲
      description: 將指定遊戲的狀態設為活動並開始第一個問題
      tags:
        - 遊戲管理
      parameters:
        - name: gameId
          in: path
          required: true
          schema:
            type: string
          description: 遊戲唯一ID
          example: "a1b2c3d4"
      responses:
        '200':
          description: 遊戲成功開始
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "遊戲已開始"
                  game:
                    $ref: '#/components/schemas/Game'
                  totalQuestions:
                    type: integer
                    description: 遊戲中的問題總數
                    example: 10
        '400':
          description: 請求錯誤，可能是遊戲已開始、無玩家或無問題
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 找不到遊戲
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: 伺服器錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /games/{gameId}/end:
    post:
      summary: 結束遊戲
      description: 將指定遊戲的狀態設為已完成
      tags:
        - 遊戲管理
      parameters:
        - name: gameId
          in: path
          required: true
          schema:
            type: string
          description: 遊戲唯一ID
          example: "a1b2c3d4"
      responses:
        '200':
          description: 遊戲成功結束
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "遊戲已結束"
                  game:
                    $ref: '#/components/schemas/Game'
                  players:
                    type: array
                    items:
                      $ref: '#/components/schemas/PlayerRanking'
        '400':
          description: 請求錯誤，可能是遊戲不在活動狀態
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 找不到遊戲
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: 伺服器錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /games/{gameId}/results:
    get:
      summary: 獲取遊戲結果
      description: 獲取已結束遊戲的結果和統計數據
      tags:
        - 遊戲管理
      parameters:
        - name: gameId
          in: path
          required: true
          schema:
            type: string
          description: 遊戲唯一ID
          example: "a1b2c3d4"
      responses:
        '200':
          description: 成功獲取遊戲結果
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  game:
                    $ref: '#/components/schemas/Game'
                  players:
                    type: array
                    items:
                      $ref: '#/components/schemas/PlayerRanking'
                  gameStats:
                    $ref: '#/components/schemas/GameStats'
        '400':
          description: 請求錯誤，可能是遊戲尚未結束
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 找不到遊戲
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: 伺服器錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /questions:
    post:
      summary: 創建問題
      description: 創建一個新的動漫問題
      tags:
        - 問題管理
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                animeTitle:
                  type: string
                  description: 動漫標題
                  example: "Attack on Titan"
                alternativeTitles:
                  type: array
                  description: 可選的動漫替代標題
                  items:
                    type: string
                  example: ["進撃の巨人", "進擊的巨人"]
                imageSets:
                  type: array
                  description: 包含圖片集的數組
                  items:
                    type: object
                    properties:
                      setId:
                        type: string
                        description: 圖片集ID (可選，如果未提供將自動生成)
                        example: "set_123456"
                      setName:
                        type: string
                        description: 圖片集名稱
                        example: "Character Set 1"
                      images:
                        type: array
                        description: 圖片URL列表
                        items:
                          type: string
                          example: "https://example.com/image1.jpg"
                        minItems: 3
                  minItems: 1
              required:
                - animeTitle
                - imageSets
      responses:
        '201':
          description: 問題創建成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "動漫問題創建成功"
                  question:
                    $ref: '#/components/schemas/Question'
        '400':
          description: 請求錯誤，可能是缺少必要欄位或圖片集不符合要求
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: 伺服器錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /games/{gameId}/questions:
    post:
      summary: 添加問題到遊戲
      description: 將問題添加到指定遊戲中
      tags:
        - 問題管理
      parameters:
        - name: gameId
          in: path
          required: true
          schema:
            type: string
          description: 遊戲唯一ID
          example: "a1b2c3d4"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                count:
                  type: integer
                  description: 要添加的問題數量
                  default: 10
                  example: 10
      responses:
        '200':
          description: 成功添加問題
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "成功添加 10 個問題到遊戲"
                  count:
                    type: integer
                    description: 實際添加的問題數量
                    example: 10
        '400':
          description: 請求錯誤，可能是遊戲已開始或無有效問題
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 找不到遊戲或數據庫中沒有可用問題
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: 伺服器錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /games/{gameId}/question:
    get:
      summary: 獲取當前問題
      description: 獲取指定遊戲的當前問題
      tags:
        - 問題管理
      parameters:
        - name: gameId
          in: path
          required: true
          schema:
            type: string
          description: 遊戲唯一ID
          example: "a1b2c3d4"
      responses:
        '200':
          description: 成功獲取當前問題
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  questionId:
                    type: string
                    description: 問題唯一ID
                    example: "5f8d5a....."
                  questionOrder:
                    type: integer
                    description: 問題順序編號
                    example: 1
                  images:
                    type: array
                    description: 圖片URL列表
                    items:
                      type: string
                      example: "https://example.com/image1.jpg"
                  animeTitle:
                    type: string
                    description: 動漫標題
                    example: "Attack on Titan"
                  alternativeTitles:
                    type: array
                    description: 動漫替代標題
                    items:
                      type: string
                    example: ["進撃の巨人", "進擊的巨人"]
        '400':
          description: 請求錯誤，可能是遊戲不在活動狀態
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 找不到遊戲、問題或圖片集
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: 伺服器錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /games/{gameId}/question/next:
    post:
      summary: 開始下一個問題
      description: 完成當前問題並開始下一個問題
      tags:
        - 問題管理
      parameters:
        - name: gameId
          in: path
          required: true
          schema:
            type: string
          description: 遊戲唯一ID
          example: "a1b2c3d4"
      responses:
        '200':
          description: 成功切換到下一個問題
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "開始下一個問題"
                  questionNumber:
                    type: integer
                    description: 新的問題編號
                    example: 2
                  totalQuestions:
                    type: integer
                    description: 問題總數
                    example: 10
                  gameComplete:
                    type: boolean
                    description: 如果是最後一個問題，此字段為true
                    example: false
        '400':
          description: 請求錯誤，可能是遊戲不在活動狀態
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 找不到遊戲
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: 伺服器錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /games/{gameId}/question/answer:
    post:
      summary: 提交答案
      description: 提交玩家對當前問題的答案
      tags:
        - 問題管理
      parameters:
        - name: gameId
          in: path
          required: true
          schema:
            type: string
          description: 遊戲唯一ID
          example: "a1b2c3d4"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                  description: 玩家名稱
                  example: "player1"
                score:
                  type: integer
                  description: 本題獲得的分數
                  example: 100
              required:
                - username
                - score
      responses:
        '200':
          description: 成功提交答案
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "分數更新成功"
                  score:
                    type: integer
                    description: 本題獲得的分數
                    example: 100
                  totalScore:
                    type: integer
                    description: 玩家總分
                    example: 300
        '400':
          description: 請求錯誤，可能是缺少必要欄位或遊戲不在活動狀態
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 找不到遊戲或玩家
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: 伺服器錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /games/{gameId}/rankings:
    get:
      summary: 獲取玩家排名
      description: 獲取指定遊戲中玩家的排名
      tags:
        - 玩家管理
      parameters:
        - name: gameId
          in: path
          required: true
          schema:
            type: string
          description: 遊戲唯一ID
          example: "a1b2c3d4"
      responses:
        '200':
          description: 成功獲取玩家排名
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  rankings:
                    type: array
                    items:
                      $ref: '#/components/schemas/PlayerRanking'
        '404':
          description: 找不到遊戲
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: 伺服器錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  schemas:
    Game:
      type: object
      properties:
        gameId:
          type: string
          description: 遊戲唯一ID
          example: "a1b2c3d4"
        gameTitle:
          type: string
          description: 遊戲標題
          example: "Anime Guessing Game"
        status:
          type: string
          description: 遊戲狀態
          enum: [waiting, active, finished]
          example: "waiting"
        settings:
          $ref: '#/components/schemas/GameSettings'
        players:
          type: array
          description: 遊戲玩家列表
          items:
            $ref: '#/components/schemas/Player'
        currentQuestionNumber:
          type: integer
          description: 當前問題編號 (1-based)
          example: 0
        startedAt:
          type: string
          format: date-time
          description: 遊戲開始時間
          example: "2025-05-20T10:30:00Z"
        finishedAt:
          type: string
          format: date-time
          description: 遊戲結束時間
          example: null
        createdAt:
          type: string
          format: date-time
          description: 遊戲創建時間
          example: "2025-05-20T10:00:00Z"
        hostId:
          type: string
          description: 主持人ID
          example: "host123456"
    
    GameSettings:
      type: object
      properties:
        revealInterval:
          type: integer
          description: 每次圖片顯示的時間間隔（秒）
          default: 5
          example: 5
        answerTime:
          type: integer
          description: 所有圖片顯示後的答題時間（秒）
          default: 20
          example: 20
        maxPointsPerQuestion:
          type: integer
          description: 每題最高分數
          default: 100
          example: 100
        rounds:
          type: integer
          description: 回合數（問題數）
          default: 10
          example: 10
    
    Player:
      type: object
      properties:
        username:
          type: string
          description: 玩家名稱
          example: "player1"
        score:
          type: integer
          description: 玩家當前分數
          example: 300
          default: 0
        joinedAt:
          type: string
          format: date-time
          description: 玩家加入時間
          example: "2025-05-20T10:15:00Z"
    
    PlayerRanking:
      type: object
      properties:
        rank:
          type: integer
          description: 玩家排名
          example: 1
        username:
          type: string
          description: 玩家名稱
          example: "player1"
        score:
          type: integer
          description: 玩家分數
          example: 300
    
    Question:
      type: object
      properties:
        _id:
          type: string
          description: 問題唯一ID
          example: "5f8d5a....."
        animeTitle:
          type: string
          description: 動漫標題
          example: "Attack on Titan"
        alternativeTitles:
          type: array
          description: 動漫替代標題
          items:
            type: string
          example: ["進撃の巨人", "進擊的巨人"]
        imageSets:
          type: array
          description: 圖片集列表
          items:
            $ref: '#/components/schemas/ImageSet'
        createdAt:
          type: string
          format: date-time
          description: 問題創建時間
          example: "2025-05-15T08:00:00Z"
    
    ImageSet:
      type: object
      properties:
        setId:
          type: string
          description: 圖片集唯一ID
          example: "set_123456"
        setName:
          type: string
          description: 圖片集名稱
          example: "Character Set 1"
        images:
          type: array
          description: 圖片URL列表
          items:
            type: string
            example: "https://example.com/image1.jpg"
          minItems: 3
    
    GameQuestion:
      type: object
      properties:
        gameId:
          type: string
          description: 遊戲ID
          example: "a1b2c3d4"
        questionId:
          type: string
          description: 問題ID
          example: "5f8d5a....."
        imageSetId:
          type: string
          description: 所選圖片集ID
          example: "set_123456"
        order:
          type: integer
          description: 問題順序
          example: 1
        status:
          type: string
          description: 問題狀態
          enum: [pending, active, completed]
          example: "pending"
        currentImageIndex:
          type: integer
          description: 當前顯示的圖片索引
          example: -1
          default: -1
        activatedAt:
          type: string
          format: date-time
          description: 問題變為活動狀態的時間
          example: null
        completedAt:
          type: string
          format: date-time
          description: 問題完成的時間
          example: null
        timeLimit:
          type: integer
          description: 此問題的時間限制（秒）
          default: 60
          example: 60
    
    GameStats:
      type: object
      properties:
        totalQuestions:
          type: integer
          description: 遊戲問題總數
          example: 10
        totalAnswers:
          type: integer
          description: 總回答次數
          example: 50
        correctAnswers:
          type: integer
          description: 正確回答次數
          example: 35
        correctPercentage:
          type: integer
          description: 正確率百分比
          example: 70
        averageScore:
          type: integer
          description: 平均分數
          example: 250
        gameDuration:
          type: integer
          description: 遊戲持續時間（秒）
          example: 600
    
    Error:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
          description: 錯誤訊息
          example: "找不到遊戲"
        error:
          type: string
          description: 詳細錯誤資訊
          example: "Game with id a1b2c3d4 not found"